<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Weekly Digest (WDWDLW) - Zcash Me</title>
    <link rel="stylesheet" href="assets/styles.css" />
    <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
    <!-- Runtime site config: defines window.CONFIG.API_BASE_URL for deployments -->
    <script src="config.js"></script>
  </head>
  <body>
    <header>
      <h1>Weekly Digest (WDWDLW)</h1>
      <p>Zcash Me · Meeting Notes + GitHub Commits + Trello Activity</p>
    </header>

    <section class="controls">
      <div class="row">
        <label>Week Start (Monday)
          <input type="date" id="startDate" />
        </label>
        <label>Week End (Next Monday)
          <input type="date" id="endDate" />
        </label>
        <label>Time Zone
          <select id="tz">
            <option value="UTC">UTC</option>
          </select>
        </label>
      </div>
    </section>

    <section class="actions">
      <button id="btnGenerate">Load Weekly Data</button>
      <span id="progressText" class="progress-text"></span>
    </section>
    <div id="progress" class="progress hidden">
      <div id="progressFill" class="progress-bar"></div>
    </div>

    <section class="results">
      <h2>Transcripts Summary (Meeting Notes)</h2>
      <div id="transcriptsSummary"></div>
    </section>

    <section class="results">
      <h2>GitHub Commits (main)</h2>
      <div id="githubCommits"></div>
    </section>

    <section class="results">
      <h2>Trello Board Activity</h2>
      <div id="trelloActivity"></div>
    </section>

    <script type="module">
      import { fetchCommits } from './src/github.js';
      import { fetchMeetingNotes, fetchBoardActions } from './src/trello.js';

      const state = { commits: [], trello: [], actions: [] };

      const startDateEl = document.getElementById('startDate');
      const endDateEl = document.getElementById('endDate');
      const tzEl = document.getElementById('tz');
      const btnGenerate = document.getElementById('btnGenerate');
      const transcriptsEl = document.getElementById('transcriptsSummary');
      const githubEl = document.getElementById('githubCommits');
      const trelloEl = document.getElementById('trelloActivity');
      const progressEl = document.getElementById('progress');
      const progressFillEl = document.getElementById('progressFill');
      const progressTextEl = document.getElementById('progressText');

      function setProgress(pct = 0, label = '') {
        progressEl.classList.remove('hidden');
        const clamped = Math.max(0, Math.min(100, Number(pct) || 0));
        progressFillEl.style.width = clamped + '%';
        if (label) progressTextEl.textContent = label;
      }
      function resetProgress() {
        progressFillEl.style.width = '0%';
        progressTextEl.textContent = '';
        progressEl.classList.add('hidden');
      }
      function setLoading(on) {
        if (on) {
          btnGenerate.disabled = true;
          btnGenerate.dataset.originalText = btnGenerate.textContent;
          btnGenerate.textContent = 'Loading…';
          btnGenerate.classList.add('loading');
          setProgress(5, 'Starting…');
        } else {
          btnGenerate.disabled = false;
          btnGenerate.textContent = btnGenerate.dataset.originalText || 'Load Weekly Data';
          btnGenerate.classList.remove('loading');
          resetProgress();
        }
      }

      function toISO(dateStr) {
        const tz = tzEl.value || 'UTC';
        const d = new Date(dateStr + 'T00:00:00Z');
        return d.toISOString();
      }

      btnGenerate.addEventListener('click', async () => {
        const startISO = toISO(startDateEl.value);
        const endISO = toISO(endDateEl.value);
        if (!startISO || !endISO) { alert('Please set the week start and end dates.'); return; }
        setLoading(true);

        try {
          state.commits = await fetchCommits({ owner: 'ZcashUsersGroup', repo: 'zcashme', branch: 'main', since: startISO, until: endISO });
          setProgress(33, 'GitHub commits loaded');
        } catch (e) { console.error('GitHub API Error', e); alert('GitHub commits fetch failed: ' + (e?.message || e)); setProgress(33, 'GitHub commits failed'); }

        try {
          state.trello = await fetchMeetingNotes({ boardName: 'Zcash Me', listName: 'Meeting Notes', since: startISO, until: endISO });
          setProgress(66, 'Meeting notes loaded');
        } catch (e) { console.error('Trello API Error', e); alert('Trello meeting notes fetch failed: ' + (e?.message || e)); setProgress(66, 'Meeting notes failed'); }

        // Trello board actions
        try {
          state.actions = await fetchBoardActions({ boardName: 'Zcash Me', since: startISO, until: endISO, types: 'all' });
          setProgress(90, 'Board actions loaded');
        } catch (e) { console.error('Trello API Error', e); alert('Trello board actions fetch failed: ' + (e?.message || e)); setProgress(90, 'Board actions failed'); }

        // Render sections
        transcriptsEl.innerHTML = renderMeetingNotes(state.trello);
        githubEl.innerHTML = renderCommits(state.commits);
        trelloEl.innerHTML = renderActions(state.actions);
        setProgress(100, 'Done');
        setTimeout(() => setLoading(false), 250);
      });

      function esc(s) { return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
      function firstLine(s){return String(s||'').split('\n')[0].trim()}

      function renderCommits(commits = []) {
        if (!Array.isArray(commits) || commits.length === 0) return '<p>No commits.</p>';
        return '<ul>' + commits.map(c => 
          `<li>${esc(c.date || '')} ${esc(c.author || '')}: ${esc(firstLine(c.message || ''))} ` +
          (c.url ? `<a href="${esc(c.url)}" target="_blank">link</a>` : '') + '</li>'
        ).join('') + '</ul>';
      }

      function renderMeetingNotes(cards = []) {
        if (!Array.isArray(cards) || cards.length === 0) return '<p>No meeting notes.</p>';
        return '<ul>' + cards.map(c => {
          const comments = Array.isArray(c.comments) ? c.comments.length : 0;
          const attachments = Array.isArray(c.attachments) ? c.attachments.length : 0;
          const desc = esc(String(c.desc || '').slice(0, 300));
          return `<li>${esc(c.dateLastActivity || '')} ${esc(c.name || '')} ` +
                 (c.url ? `(<a href="${esc(c.url)}" target="_blank">link</a>) ` : '') +
                 `– Desc: ${desc}` +
                 (comments ? ` · ${comments} comments` : '') +
                 (attachments ? ` · ${attachments} attachments` : '') +
                 `</li>`;
        }).join('') + '</ul>';
      }

      function renderActions(actions = []) {
        if (!Array.isArray(actions) || actions.length === 0) return '<p>No actions.</p>';
        return '<ul>' + actions.map(a => {
          const parts = [esc(a.date || ''), esc(a.type || '')];
          if (a.member) parts.push(esc(a.member));
          if (a.card) parts.push(esc(a.card));
          if (a.list) parts.push(`(${esc(a.list)})`);
          if (a.text) parts.push('– ' + esc(a.text));
          return `<li>${parts.join(' · ')}</li>`;
        }).join('') + '</ul>';
      }
    </script>
  </body>
  </html>